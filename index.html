<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DMS – Hub Nazionale del Commercio</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <div class="container">
    <div class="hero card">
      <div>
        <h1>DMS – Hub Nazionale del Commercio</h1>
        <p>Minisito pronto per pubblicazione (GitHub Pages). Include link al cruscotto e materiali.</p>
      </div>
      <div>
        <a href="#" id="openDash" class="btn">Apri Cruscotto DMS</a>
        <a href="?admin=true" class="btn alt">Admin</a>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h3 class="section-title">Anteprima <span class="badge">Video</span></h3>
        <div class="video-box" id="previewBox">
          <small class="muted">Aggiungi un file in <code>/site/assets/preview.jpg</code> oppure un video in <code>/site/videos/</code></small>
        </div>
        <div class="hr"></div>
        <p><small class="muted">Suggerimento: per file .MOV pesanti, usa n8n presigned URL o host esterno.</small></p>
      </section>

      <section class="card">
        <h3 class="section-title">Documenti <span class="badge">PDF</span></h3>
        <ul class="list" id="pdfList">
          <!-- Popolato da manifest.json -->
        </ul>
      </section>

      <section class="card">
        <h3 class="section-title">Video <span class="badge">Media</span></h3>
        <ul class="list" id="videoList">
          <!-- Popolato da manifest.json -->
        </ul>
      </section>
    </div>

    <section id="admin" class="card" style="margin-top:18px; display:none">
      <h3>Admin</h3>
      <p><small class="muted">Sezione visibile quando l'URL contiene <code>?admin=true</code>. Prevede collegamento a n8n per presigned upload e registrazione contenuti.</small></p>
      <ul class="list">
        <li>Upload via n8n (presigned URL + register)</li>
        <li>Upload diretto su GitHub (Contents API, PAT)</li>
        <li>Aggiornamento <code>content/manifest.json</code></li>
      </ul>
    </section>

    <p class="footer">© 2025 DMS – Digital Market System</p>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const isAdmin = params.get('admin') === 'true';
    if (isAdmin) document.getElementById('admin').style.display = 'block';

    const DASH_URL = params.get('dash') || '#'; // sostituito da Manus con URL reale
    document.getElementById('openDash').setAttribute('href', DASH_URL);

    fetch('content/manifest.json')
      .then(r => r.json())
      .then(data => {{ render(data); }})
      .catch(() => {{ render({{pdfs:[],videos:[]}}); }});

    function render(data){{
      const pdfList = document.getElementById('pdfList');
      const videoList = document.getElementById('videoList');
      const makeItem = (t,u)=>`<li><a class="btn alt" href="${u}" download>${t}</a></li>`;

      if(data.pdfs?.length){{
        pdfList.innerHTML = data.pdfs.map(x=>makeItem(x.title||x.file, x.url||( 'docs/' + x.file ))).join('');
      }} else {{
        pdfList.innerHTML = '<li><small class="muted">Nessun PDF registrato.</small></li>';
      }}

      if(data.videos?.length){{
        videoList.innerHTML = data.videos.map(x=>makeItem(x.title||x.file, x.url||( 'videos/' + x.file ))).join('');
      }} else {{
        videoList.innerHTML = '<li><small class="muted">Nessun video registrato.</small></li>';
      }}
    }}
  </script>
</body>
</html>
